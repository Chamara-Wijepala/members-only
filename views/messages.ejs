<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head.ejs') %>

<body>
  <main>
    <h2>Messages</h2>

    <% if (currentUser.is_member) { %>
    <h3>Post a new message</h3>
    <form action="/messages" method="post">
      <label for="message-title">Title</label>
      <input type="text" name="title" id="message-title" required>

      <label for="message-body">Message</label>
      <input type="text" name="body" id="message-body" required>

      <button type="submit">Post</button>
    </form>
    <% } %>

    <div>
      <% messages.forEach(message => { %>
      <div>
        <!-- If user is a member -->
        <% if (message.username) { %>
        <div>
          <p><%= message.username %></p>
          <p><%= message.timestamp %></p>
        </div>
        <% } %>

        <h3><%= message.title %></h3>
        <p><%= message.body %></p>

        <% if (currentUser.is_admin) { %>
        <button class="delete-btn" data-id="<%= message.id %>">Delete</button>
        <% } %>
      </div>
      <% }) %>
    </div>
  </main>
</body>

<script>
  const deleteButtons = document.querySelectorAll('.delete-btn')

  deleteButtons.forEach(button => {
    button.addEventListener('click', async () => {
      const messageId = button.getAttribute('data-id');

      const response = await fetch(`/messages/${messageId}`, {
        method: 'DELETE'
      })

      if (response.status === 200) {
        location.reload()
      }
    })
  })
</script>

</html>